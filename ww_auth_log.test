<?php

/**
* Tests ww_auth_log is logging user events.
**/
class WWAuthLogTestCase extends DrupalWebTestCase {
  /**
  * Test Case metadata
  */
  public static function getInfo() {
    return array(
      'name' => 'WW Auth log Test',
      'description' => 'Test user events are logged correctly',
      'group' => '__ww__',
    );
  }

  public function setUp() {
    // enable ww_auth_log
    parent::setUp(array('ww_auth_log'));
  }

  /**
  * Failed login attempts should be logged to ../logs/drupal_auth.log.
  **/
  public function testFailedLogin() {
    // Create unknown login post
    $form = array();
    $username = 'ww_auth_log.test_'.$this->randomName(8);
    $form['name'] = $username;
    $form['pass'] = $this->randomName(8);
    $this->drupalPost('user/login', $form, t('Log in'));

    // sanity check it failed
    $this->assertText(t('Sorry, unrecognized username or password.'));

    // check the log
    $regex = "/.*Login attempt failed for $username/";
    $log = file_get_contents(DRUPAL_ROOT.'/../logs/drupal_auth.log');
    $this->assertTrue(preg_match($regex, $log));
  }
}
